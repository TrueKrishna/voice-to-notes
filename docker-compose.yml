version: '3.8'

services:
  # ── V1 Web App ──────────────────────────────────────────────────
  app:
    build: .
    container_name: voice-to-notes
    ports:
      - "9123:8000"
    volumes:
      - voice_notes_data:/app/data
      # Broad Google Drive mount — user picks subdirectories in Settings UI
      - ${GDRIVE_MOUNT_PATH:-./_placeholder_gdrive}:/data/gdrive
    environment:
      - DATABASE_URL=sqlite:///./data/voice_notes.db
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ── V2 Watcher Engine ──────────────────────────────────────────
  watcher:
    build: .
    container_name: voice-to-notes-watcher
    command: python run_watcher.py
    volumes:
      - voice_notes_data:/app/data
      # Same broad mount — watcher reads paths from DB Settings
      - ${GDRIVE_MOUNT_PATH:-./_placeholder_gdrive}:/data/gdrive
    environment:
      - DATABASE_URL=sqlite:///./data/voice_notes.db
      # Fallback paths if DB settings not yet configured
      - LOCAL_SYNC_AUDIO_DIR=/data/gdrive
      - OBSIDIAN_VAULT_DIR=/data/gdrive
    env_file:
      - .env
    restart: unless-stopped
    depends_on:
      app:
        condition: service_healthy

volumes:
  voice_notes_data:
    driver: local

# ============================================================================
# Optional: PostgreSQL instead of SQLite (uncomment to use)
# ============================================================================
# services:
#   app:
#     build: .
#     container_name: voice-to-notes
#     ports:
#       - "8000:8000"
#     volumes:
#       - voice_notes_uploads:/app/data/uploads
#     environment:
#       - DATABASE_URL=postgresql://voice:voice_password@db:5432/voice_notes
#     depends_on:
#       db:
#         condition: service_healthy
#     restart: unless-stopped
#
#   db:
#     image: postgres:15-alpine
#     container_name: voice-to-notes-db
#     environment:
#       - POSTGRES_USER=voice
#       - POSTGRES_PASSWORD=voice_password
#       - POSTGRES_DB=voice_notes
#     volumes:
#       - postgres_data:/var/lib/postgresql/data
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U voice -d voice_notes"]
#       interval: 5s
#       timeout: 5s
#       retries: 5
#     restart: unless-stopped
#
# volumes:
#   voice_notes_uploads:
#   postgres_data:
