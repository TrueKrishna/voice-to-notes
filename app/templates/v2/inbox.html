{% extends "v2/base.html" %}

{% block title %}Inbox — L1{% endblock %}

{% block head %}
<script>window.__inboxNotes = {{ notes | tojson }};
window.__filterTag = {{ filter_tag | tojson }};</script>
{% endblock %}

{% block content %}
<div x-data="inboxView(window.__inboxNotes, window.__filterTag)">
    
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Inbox</h1>
            <p class="page-subtitle">
                <span x-text="filteredNotes.length"></span> notes
                <template x-if="tagFilter">
                    <span> tagged <strong x-text="'#' + tagFilter"></strong>
                        <button @click="clearTagFilter()" class="text-muted" style="background:none; border:none; cursor:pointer; margin-left:4px; font-size:0.75rem;">&times;</button>
                    </span>
                </template>
            </p>
        </div>
        <div class="page-actions">
            <div class="input-group" style="width: 280px;">
                <span class="input-icon">
                    <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                </span>
                <input type="text" 
                       class="input" 
                       placeholder="Search notes... (/)" 
                       x-model="searchQuery"
                       data-search-input>
            </div>
            <button class="btn btn-secondary" @click="$dispatch('open-upload')">
                <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                Upload
            </button>
        </div>
    </div>
    
    <!-- Filter Bar -->
    <div class="filter-bar">
        <button class="filter-tab" :class="{ 'active': filter === 'all' }" @click="filter = 'all'">
            All
        </button>
        <button class="filter-tab" :class="{ 'active': filter === 'completed' }" @click="filter = 'completed'">
            Processed
        </button>
        <button class="filter-tab" :class="{ 'active': filter === 'pending' }" @click="filter = 'pending'">
            Pending
        </button>
        <button class="filter-tab" :class="{ 'active': filter === 'processing' }" @click="filter = 'processing'">
            Processing
        </button>
        <button class="filter-tab" :class="{ 'active': filter === 'failed' }" @click="filter = 'failed'">
            Failed
        </button>
    </div>
    
    <!-- Split View: List + Inspector -->
    <div class="split-view" style="height: calc(100vh - 240px);">
        
        <!-- Left Panel: Note List (Selection Only) -->
        <div class="split-primary">
            <div class="panel" style="height: 100%; display: flex; flex-direction: column;">
                <div style="flex: 1; overflow-y: auto;">
                    
                    <template x-if="filteredNotes.length === 0">
                        <div class="empty-state">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; color: var(--text-muted); margin-bottom: var(--space-4);"></i>
                            <p class="empty-state-title">No notes found</p>
                            <p class="empty-state-text">
                                <template x-if="searchQuery">
                                    Try a different search term
                                </template>
                                <template x-if="!searchQuery && filter !== 'all'">
                                    No notes with this status
                                </template>
                                <template x-if="!searchQuery && filter === 'all'">
                                    Upload audio files to create notes
                                </template>
                            </p>
                            <button class="btn btn-primary" style="margin-top: var(--space-4);" @click="$dispatch('open-upload')">
                                <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                                Upload Audio
                            </button>
                        </div>
                    </template>
                    
                    <template x-for="note in filteredNotes" :key="note.id">
                        <div class="list-item" 
                             :class="{ 'selected': selectedId === note.id }"
                             @click="select(note)"
                             style="cursor: pointer;">
                            <div class="list-item-content" style="flex: 1;">
                                <div class="list-item-title" x-text="note.title || note.filename || 'Untitled'"></div>
                                <div class="list-item-meta">
                                    <template x-if="note.projects && note.projects.length > 0">
                                        <span>
                                            <span class="text-xs" style="color: var(--accent);" x-text="note.projects[0]"></span>
                                            <span> · </span>
                                        </span>
                                    </template>
                                    <span x-text="timeAgo(note.captured_at || note.processed_at || note.created_at)"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                </div>
            </div>
        </div>
        
        <!-- Right Panel: Inspector (Primary Control Surface) -->
        <div class="split-secondary">
            <div class="panel" style="height: 100%; display: flex; flex-direction: column;">
                
                <template x-if="!selectedId">
                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: var(--space-8);">
                        <i data-lucide="file-text" style="width: 40px; height: 40px; color: var(--text-muted); margin-bottom: var(--space-3); opacity: 0.5;"></i>
                        <p class="text-sm text-secondary" style="margin-bottom: var(--space-1);">Select a note</p>
                        <p class="text-xs text-muted">Click on a note to preview and manage it</p>
                    </div>
                </template>
                
                <template x-if="selectedId">
                    <div x-data="{ 
                        get note() { return filteredNotes.find(n => n.id === selectedId); },
                        viewMode: 'summary',
                        showProjectDropdown: false,
                        showMoreOptions: false,
                        newProject: '',
                        get rendered() {
                            const c = this.note?.content || '';
                            if (!c) return '';
                            if (typeof marked !== 'undefined') {
                                try {
                                    let text = c;
                                    if (text.startsWith('---')) { const end = text.indexOf('---', 3); if (end !== -1) text = text.substring(end + 3).trim(); }
                                    return marked.parse(text);
                                } catch(e) { console.warn('marked error', e); }
                            }
                            const d = document.createElement('div');
                            d.textContent = c;
                            return d.innerHTML;
                        }
                    }" style="display: flex; flex-direction: column; height: 100%;">
                        
                        <!-- Inspector Header with Actions -->
                        <div class="panel-header" style="gap: var(--space-3); border-bottom: 1px solid var(--border-subtle);">
                            <div style="min-width:0; flex:1;">
                                <h3 class="text-md font-semibold" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom: var(--space-1);" x-text="note?.title || note?.filename || 'Untitled'"></h3>
                                
                                <!-- Project Label (Clickable) -->
                                <div style="position: relative; display: inline-block;">
                                    <button @click="showProjectDropdown = !showProjectDropdown" 
                                            class="text-xs" 
                                            style="background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.3); color: var(--accent); padding: 2px 8px; border-radius: 4px; cursor: pointer; font-weight: 500;">
                                        <span x-text="(note?.projects && note.projects.length > 0) ? note.projects[0] : 'No Project'"></span>
                                        <span style="margin-left: 4px;">&#9662;</span>
                                    </button>
                                    
                                    <!-- Project Dropdown -->
                                    <div x-show="showProjectDropdown" 
                                         @click.away="showProjectDropdown = false"
                                         class="dropdown-menu"
                                         style="position: absolute; top: 100%; left: 0; margin-top: 4px; min-width: 180px; background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: 6px; padding: var(--space-2); z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                        <div style="max-height: 200px; overflow-y: auto;">
                                            <div @click="$parent.assignProject(null); showProjectDropdown = false" 
                                                 class="dropdown-item" 
                                                 style="padding: var(--space-2); cursor: pointer; border-radius: 4px; font-size: 0.8125rem;">
                                                <span style="color: var(--text-muted);">— No Project —</span>
                                            </div>
                                            <template x-for="proj in $parent.knownProjects" :key="proj">
                                                <div @click="$parent.assignProject(proj); showProjectDropdown = false" 
                                                     class="dropdown-item" 
                                                     style="padding: var(--space-2); cursor: pointer; border-radius: 4px; font-size: 0.8125rem; color: var(--text-secondary);"
                                                     :style="(note?.projects || []).includes(proj) ? 'background: rgba(99,102,241,0.1);' : ''"
                                                     @mouseenter="$el.style.background = 'var(--bg-elevated)'"
                                                     @mouseleave="$el.style.background = (note?.projects || []).includes(proj) ? 'rgba(99,102,241,0.1)' : 'transparent'">
                                                    <span x-text="proj"></span>
                                                </div>
                                            </template>
                                        </div>
                                        <div style="border-top: 1px solid var(--border-subtle); margin-top: var(--space-2); padding-top: var(--space-2);">
                                            <input x-model="newProject" 
                                                   placeholder="New project..."
                                                   @keydown.enter="$parent.createAndAssignProject(newProject); newProject = ''; showProjectDropdown = false"
                                                   class="input"
                                                   style="width: 100%; font-size: 0.75rem; padding: 4px 8px;">
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display:flex; align-items:center; gap:var(--space-2); margin-top:4px;">
                                    <span class="text-xs text-muted" x-text="formatDate(note?.captured_at || note?.processed_at || note?.created_at)"></span>
                                </div>
                            </div>
                            
                            <!-- Top Action Bar (Icons Only) -->
                            <div style="display: flex; gap: 6px; align-items: center;">
                                <button @click="$parent.openAudio()" 
                                        :disabled="!note?.audio_url"
                                        :title="note?.audio_url ? 'Play audio' : 'No audio available'"
                                        class="btn-icon"
                                        :style="!note?.audio_url ? 'opacity: 0.3; cursor: not-allowed;' : ''">
                                    <i data-lucide="headphones" style="width: 15px; height: 15px;"></i>
                                </button>
                                <button @click="$parent.openNote()" 
                                        title="Open note in full view"
                                        class="btn-icon">
                                    <i data-lucide="external-link" style="width: 15px; height: 15px;"></i>
                                </button>
                                <button @click="$parent.copyTranscript()" 
                                        :disabled="!note?.transcript"
                                        :title="note?.transcript ? 'Copy transcript' : 'No transcript available'"
                                        class="btn-icon"
                                        :style="!note?.transcript ? 'opacity: 0.3; cursor: not-allowed;' : ''">
                                    <i data-lucide="clipboard-copy" style="width: 15px; height: 15px;"></i>
                                </button>
                                <button @click="$parent.downloadTranscript()" 
                                        :disabled="!note?.transcript"
                                        :title="note?.transcript ? 'Download transcript' : 'No transcript available'"
                                        class="btn-icon"
                                        :style="!note?.transcript ? 'opacity: 0.3; cursor: not-allowed;' : ''">
                                    <i data-lucide="download" style="width: 15px; height: 15px;"></i>
                                </button>
                                <button @click="$parent.copyBreakdown()" 
                                        :disabled="!note?.content"
                                        :title="note?.content ? 'Copy summary' : 'No summary available'"
                                        class="btn-icon"
                                        :style="!note?.content ? 'opacity: 0.3; cursor: not-allowed;' : ''">
                                    <i data-lucide="copy" style="width: 15px; height: 15px;"></i>
                                </button>
                                <button @click="$parent.downloadBreakdown()" 
                                        :disabled="!note?.content"
                                        :title="note?.content ? 'Download summary' : 'No summary available'"
                                        class="btn-icon"
                                        :style="!note?.content ? 'opacity: 0.3; cursor: not-allowed;' : ''">
                                    <i data-lucide="file-down" style="width: 15px; height: 15px;"></i>
                                </button>
                                <button @click="showMoreOptions = !showMoreOptions" 
                                        title="More options"
                                        class="btn-icon">
                                    <i data-lucide="more-horizontal" style="width: 15px; height: 15px;"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Content Switcher (Summary vs Transcript) -->
                        <div style="display: flex; gap: 0; border-bottom: 1px solid var(--border-subtle); padding: 0 var(--space-4);">
                            <button @click="viewMode = 'summary'" 
                                    :class="viewMode === 'summary' ? 'active' : ''"
                                    class="content-switcher-btn">
                                Summary
                            </button>
                            <button @click="viewMode = 'transcript'" 
                                    :class="viewMode === 'transcript' ? 'active' : ''"
                                    class="content-switcher-btn">
                                Transcript
                            </button>
                        </div>
                        
                        <!-- Content Area -->
                        <div class="panel-content" style="flex: 1; overflow-y: auto;">
                            <!-- Summary View -->
                            <template x-if="viewMode === 'summary'">
                                <div>
                                    <template x-if="note?.content">
                                        <div class="md-content" style="font-size:0.8125rem; line-height:1.65;" x-html="rendered"></div>
                                    </template>
                                    <template x-if="!note?.content">
                                        <div class="empty-state" style="padding:var(--space-6);">
                                            <p class="text-sm text-muted">No summary available</p>
                                            <template x-if="note?.status !== 'completed'">
                                                <p class="text-xs text-muted" style="margin-top:6px;">Processing not complete</p>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            
                            <!-- Transcript View -->
                            <template x-if="viewMode === 'transcript'">
                                <div>
                                    <template x-if="note?.transcript">
                                        <div class="text-sm text-secondary" style="white-space: pre-wrap; line-height: 1.6;" 
                                             x-text="note.transcript"></div>
                                    </template>
                                    <template x-if="!note?.transcript">
                                        <div class="empty-state" style="padding:var(--space-6);">
                                            <p class="text-sm text-muted">No transcript available</p>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                        
                    </div>
                </template>
                
            </div>
        </div>
        
    </div>
    
</div>
{% endblock %}

{% block status_left %}
{{ notes | length }} notes in inbox
{% endblock %}
