{% extends "v2/base.html" %}

{% block title %}{{ note.title or note.filename }} — L1{% endblock %}

{% block head %}
<script>window.__noteData = {{ note | tojson }};
window.__knownProjects = {{ known_projects | tojson }};</script>
<style>
/* ── Note detail page styles ── */
.note-header { display:flex; align-items:flex-start; gap:var(--space-3); margin-bottom:var(--space-4); }
.note-header-info { flex:1; min-width:0; }
.note-header-actions { display:flex; gap:var(--space-2); flex-shrink:0; }
.note-meta-row { display:flex; flex-wrap:wrap; align-items:center; gap:var(--space-2); margin-top:var(--space-1); }

/* Tabs */
.content-tabs { display:flex; gap:0; border-bottom:1px solid var(--border-subtle); margin-bottom:0; }
.content-tab { padding:var(--space-2) var(--space-4); font-size:0.8125rem; font-weight:500; color:var(--text-muted);
  cursor:pointer; border:none; background:none; border-bottom:2px solid transparent; transition:all 0.15s; }
.content-tab:hover { color:var(--text-secondary); }
.content-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.content-tab .tab-badge { margin-left:6px; font-size:0.6875rem; padding:1px 6px; border-radius:8px;
  background:var(--bg-tertiary); color:var(--text-muted); }

/* Markdown rendered content */
.md-content { font-size:0.875rem; line-height:1.75; color:var(--text-secondary); }
.md-content h1 { font-size:1.25rem; color:var(--text-primary); margin:1.5em 0 0.5em; font-weight:600; }
.md-content h2 { font-size:1.1rem; color:var(--text-primary); margin:1.25em 0 0.5em; font-weight:600; border-bottom:1px solid var(--border-subtle); padding-bottom:0.25em; }
.md-content h3 { font-size:0.95rem; color:var(--text-primary); margin:1em 0 0.4em; font-weight:600; }
.md-content p { margin:0.5em 0; }
.md-content ul, .md-content ol { margin:0.5em 0; padding-left:1.5em; }
.md-content li { margin:0.25em 0; }
.md-content li input[type="checkbox"] { margin-right:6px; accent-color:var(--accent); }
.md-content blockquote { border-left:3px solid var(--accent); margin:0.75em 0; padding:0.25em 1em; color:var(--text-muted); background:var(--bg-tertiary); border-radius:0 var(--radius) var(--radius) 0; }
.md-content code { font-size:0.8125rem; padding:2px 5px; border-radius:3px; background:var(--bg-tertiary); color:var(--accent); }
.md-content pre { background:var(--bg-tertiary); padding:var(--space-3); border-radius:var(--radius); overflow-x:auto; margin:0.75em 0; }
.md-content pre code { padding:0; background:none; }
.md-content strong { color:var(--text-primary); }
.md-content hr { border:none; border-top:1px solid var(--border-subtle); margin:1em 0; }
.md-content table { border-collapse:collapse; width:100%; margin:0.75em 0; font-size:0.8125rem; }
.md-content th, .md-content td { border:1px solid var(--border-subtle); padding:6px 10px; text-align:left; }
.md-content th { background:var(--bg-tertiary); font-weight:600; color:var(--text-primary); }

/* Chips */
.chip-container { display:flex; flex-wrap:wrap; gap:6px; }
.chip { display:inline-flex; align-items:center; gap:4px; padding:2px 10px; border-radius:12px;
  font-size:0.75rem; font-weight:500; background:var(--bg-tertiary); color:var(--text-secondary); border:1px solid var(--border-subtle); }
.chip-remove { cursor:pointer; opacity:0.5; font-size:0.875rem; line-height:1; }
.chip-remove:hover { opacity:1; color:var(--error); }
.chip-add { cursor:pointer; border-style:dashed; color:var(--text-muted); transition:color 0.15s; }
.chip-add:hover { color:var(--accent); border-color:var(--accent); }
.chip-project { background:rgba(99,102,241,0.1); border-color:rgba(99,102,241,0.3); color:var(--accent); }
.chip-input { border:1px solid var(--accent); border-radius:12px; padding:2px 8px; font-size:0.75rem;
  background:transparent; color:var(--text-primary); outline:none; width:100px; }
.chip-input::placeholder { color:var(--text-muted); }

/* Detail grid */
.detail-grid { display:grid; grid-template-columns:1fr 280px; gap:var(--space-4); align-items:start; }
@media (max-width:900px) { .detail-grid { grid-template-columns:1fr; } }

/* Meta table */
.meta-table { width:100%; font-size:0.8125rem; }
.meta-table td { padding:5px 0; vertical-align:top; }
.meta-table td:first-child { color:var(--text-muted); white-space:nowrap; padding-right:12px; width:80px; }
.meta-table td:last-child { color:var(--text-secondary); overflow:hidden; text-overflow:ellipsis; max-width:180px; word-break:break-all; }
.meta-hash { font-family:monospace; font-size:0.625rem; max-width:170px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:block; cursor:help; }

/* Transcript view */
.transcript-content { font-size:0.8125rem; line-height:1.8; color:var(--text-secondary); white-space:pre-wrap; word-break:break-word; }
.transcript-content .timestamp { color:var(--accent); font-size:0.75rem; font-weight:500; }

/* Download row */
.download-row { display:flex; gap:var(--space-2); }
.download-row .btn { flex:1; justify-content:center; font-size:0.75rem; }
</style>
{% endblock %}

{% block content %}
<div x-data="registryNote(window.__noteData, window.__knownProjects)">

    <!-- ───────────── Header ───────────── -->
    <div class="note-header">
        <a href="/v2/inbox" class="btn btn-sm btn-ghost" title="Back">&larr;</a>
        <div class="note-header-info">
            <h1 class="page-title" x-text="note.title || note.filename" style="margin:0;"></h1>
            <div class="note-meta-row">
                <span class="file-badge" :class="note.success ? 'badge-completed' : 'badge-failed'" x-text="note.success ? 'COMPLETED' : 'FAILED'"></span>
                <template x-if="note.mode"><span class="log-mode" x-text="note.mode"></span></template>
                <span class="text-xs text-muted" x-text="formatDate(note.processed_at)"></span>
                <template x-if="note.duration_seconds">
                    <span class="text-xs text-muted" x-text="formatDuration(note.duration_seconds)"></span>
                </template>
                <template x-if="wordCount > 0">
                    <span class="text-xs text-muted" x-text="wordCount + ' words · ' + readTime + ' min read'"></span>
                </template>
            </div>
        </div>
        <div class="note-header-actions">
            <button class="btn btn-sm btn-secondary" @click="reprocess()" :disabled="processing">↻ Reprocess</button>
            <button class="btn btn-sm btn-ghost" style="color:var(--error);" @click="deleteNote()">✕ Delete</button>
        </div>
    </div>

    <!-- ───────────── Error banner ───────────── -->
    <template x-if="note.error">
        <div class="panel" style="margin-bottom:var(--space-4); border-color:var(--error);">
            <div class="panel-header">
                <span class="panel-title" style="color:var(--error);">Processing Error</span>
                <template x-if="note.retry_count"><span class="text-xs text-muted" x-text="'Retry #' + note.retry_count"></span></template>
            </div>
            <div class="panel-content">
                <pre class="text-sm" style="color:var(--error); white-space:pre-wrap; word-break:break-all; margin:0;" x-text="note.error"></pre>
            </div>
        </div>
    </template>

    <!-- ───────────── Main layout ───────────── -->
    <div class="detail-grid">

        <!-- Left: Content panel -->
        <div class="panel" style="overflow:hidden;">
            <!-- Tabs -->
            <div class="content-tabs">
                <button class="content-tab" :class="{ active: tab === 'note' }" @click="tab = 'note'">
                    Structured Note
                    <template x-if="note.content"><span class="tab-badge" x-text="wordCount + 'w'"></span></template>
                </button>
                <button class="content-tab" :class="{ active: tab === 'transcript' }" @click="tab = 'transcript'">
                    Raw Transcript
                    <template x-if="note.transcript"><span class="tab-badge" x-text="transcriptWordCount + 'w'"></span></template>
                    <template x-if="!note.transcript"><span class="tab-badge">—</span></template>
                </button>
            </div>

            <!-- Tab: Structured Note (Markdown) -->
            <div x-show="tab === 'note'" class="panel-content" style="min-height:250px; padding:var(--space-4);">
                <template x-if="note.content">
                    <div class="md-content" x-html="renderedContent"></div>
                </template>
                <template x-if="!note.content">
                    <div class="empty-state" style="padding:var(--space-8);">
                        <p class="text-sm text-muted">No structured note content available</p>
                        <template x-if="note.note_path"><p class="text-xs text-muted" x-text="'Expected at: ' + note.note_path"></p></template>
                        <template x-if="!note.success"><p class="text-xs text-muted" style="margin-top:8px;">Processing failed — try reprocessing</p></template>
                    </div>
                </template>
            </div>

            <!-- Tab: Raw Transcript -->
            <div x-show="tab === 'transcript'" class="panel-content" style="min-height:250px; padding:var(--space-4);">
                <template x-if="note.transcript">
                    <div class="transcript-content" x-html="highlightTimestamps(note.transcript)"></div>
                </template>
                <template x-if="!note.transcript">
                    <div class="empty-state" style="padding:var(--space-8);">
                        <p class="text-sm text-muted">No raw transcript available</p>
                        <template x-if="note.transcript_path"><p class="text-xs text-muted" x-text="'Expected at: ' + note.transcript_path"></p></template>
                        <p class="text-xs text-muted" style="margin-top:8px;">Transcripts are stored separately from structured notes</p>
                    </div>
                </template>
            </div>
        </div>

        <!-- Right: Sidebar panels -->
        <div style="display:flex; flex-direction:column; gap:var(--space-3);">

            <!-- Audio Player -->
            <template x-if="note.audio_url">
                <div class="panel">
                    <div class="panel-header"><span class="panel-title">Audio</span></div>
                    <div class="panel-content">
                        <audio controls preload="metadata" style="width:100%; height:36px;" :src="note.audio_url"></audio>
                    </div>
                </div>
            </template>

            <!-- Downloads -->
            <div class="panel">
                <div class="panel-header"><span class="panel-title">Downloads</span></div>
                <div class="panel-content">
                    <div class="download-row">
                        <button class="btn btn-sm btn-secondary" @click="download('note')" :disabled="!note.content">↓ Note</button>
                        <button class="btn btn-sm btn-secondary" @click="download('transcript')" :disabled="!note.transcript">↓ Transcript</button>
                    </div>
                    <div style="margin-top:8px;">
                        <button class="btn btn-sm btn-ghost" style="width:100%; justify-content:center; font-size:0.75rem;" @click="copyContent()">
                            Copy <span x-text="tab === 'note' ? 'note' : 'transcript'"></span> to clipboard
                        </button>
                    </div>
                </div>
            </div>

            <!-- Projects -->
            <div class="panel">
                <div class="panel-header"><span class="panel-title">Projects</span></div>
                <div class="panel-content">
                    <div class="chip-container">
                        <!-- Mode chip (always present, not removable) -->
                        <template x-if="note.mode">
                            <span class="chip chip-project" x-text="note.mode" style="opacity:0.7;" title="Processing mode (auto-assigned)"></span>
                        </template>
                        <!-- User-assigned projects -->
                        <template x-for="(proj, i) in note.projects" :key="'p'+i">
                            <span class="chip chip-project">
                                <span x-text="proj"></span>
                                <span class="chip-remove" @click="removeProject(i)">&times;</span>
                            </span>
                        </template>
                        <!-- Add project -->
                        <template x-if="!showProjectInput">
                            <span class="chip chip-add" @click="showProjectInput = true">+ Project</span>
                        </template>
                        <template x-if="showProjectInput">
                            <span style="position:relative;">
                                <input class="chip-input" x-ref="projectInput" x-model="newProject"
                                    placeholder="project name" list="known-projects-list"
                                    @keydown.enter="addProject()" @keydown.escape="showProjectInput = false"
                                    @blur="setTimeout(() => showProjectInput = false, 150)">
                                <datalist id="known-projects-list">
                                    <template x-for="kp in knownProjects" :key="kp">
                                        <option :value="kp"></option>
                                    </template>
                                </datalist>
                            </span>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Tags -->
            <div class="panel">
                <div class="panel-header"><span class="panel-title">Tags</span></div>
                <div class="panel-content">
                    <div class="chip-container">
                        <template x-for="(tag, i) in note.tags" :key="'t'+i">
                            <span class="chip">
                                <span x-text="'#' + tag"></span>
                                <span class="chip-remove" @click="removeTag(i)">&times;</span>
                            </span>
                        </template>
                        <template x-if="!showTagInput">
                            <span class="chip chip-add" @click="showTagInput = true">+ Tag</span>
                        </template>
                        <template x-if="showTagInput">
                            <input class="chip-input" x-ref="tagInput" x-model="newTag"
                                placeholder="tag name"
                                @keydown.enter="addTag()" @keydown.escape="showTagInput = false"
                                @blur="setTimeout(() => showTagInput = false, 150)">
                        </template>
                    </div>
                </div>
            </div>

            <!-- Details -->
            <div class="panel">
                <div class="panel-header"><span class="panel-title">Details</span></div>
                <div class="panel-content">
                    <table class="meta-table">
                        <tr>
                            <td>File</td>
                            <td x-text="note.filename"></td>
                        </tr>
                        <tr>
                            <td>Mode</td>
                            <td x-text="note.mode || '—'"></td>
                        </tr>
                        <tr>
                            <td>Status</td>
                            <td x-text="note.success ? 'Completed' : 'Failed'"></td>
                        </tr>
                        <tr>
                            <td>Processed</td>
                            <td x-text="formatDate(note.processed_at)"></td>
                        </tr>
                        <template x-if="note.duration_seconds">
                            <tr>
                                <td>Duration</td>
                                <td x-text="formatDuration(note.duration_seconds)"></td>
                            </tr>
                        </template>
                        <template x-if="note.file_hash">
                            <tr>
                                <td>Hash</td>
                                <td><span class="meta-hash" :title="note.file_hash" x-text="note.file_hash"></span></td>
                            </tr>
                        </template>
                        <template x-if="note.note_path">
                            <tr>
                                <td>Note file</td>
                                <td style="font-size:0.6875rem;" x-text="shortenPath(note.note_path)"></td>
                            </tr>
                        </template>
                        <template x-if="note.transcript_path">
                            <tr>
                                <td>Transcript</td>
                                <td style="font-size:0.6875rem;" x-text="shortenPath(note.transcript_path)"></td>
                            </tr>
                        </template>
                        <template x-if="note.has_tasks">
                            <tr>
                                <td>Tasks</td>
                                <td style="color:var(--accent);">Extracted</td>
                            </tr>
                        </template>
                    </table>
                </div>
            </div>

            <!-- Actions -->
            <div class="panel">
                <div class="panel-header"><span class="panel-title">Actions</span></div>
                <div class="panel-content" style="display:flex; flex-direction:column; gap:var(--space-2);">
                    <button class="btn btn-sm btn-secondary" style="width:100%; justify-content:center;" @click="reprocess()" :disabled="processing">
                        ↻ Reprocess this note
                    </button>
                    <a href="/v2/inbox" class="btn btn-sm btn-ghost" style="width:100%; justify-content:center; text-decoration:none;">
                        ← Back to Inbox
                    </a>
                    <button class="btn btn-sm btn-ghost" style="width:100%; justify-content:center; color:var(--error);" @click="deleteNote()">
                        ✕ Delete permanently
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Toast -->
    <template x-if="message">
        <div style="position:fixed; bottom:60px; right:20px; background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:var(--radius); padding:var(--space-2) var(--space-4); font-size:0.8125rem; z-index:100; max-width:300px;" x-text="message"></div>
    </template>

</div>
{% endblock %}
